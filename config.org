#+TITLE: Emacs Configuration
#+PROPERTY: header-args :tangle init.el
#+auto_tangle: yes

* straight.el

使用 use-package 和 straight.el。

#+begin_src emacs-lisp
  (setq package-archives '(("gnu"   . "http://1.15.88.122/gnu/")
			   ("melpa" . "http://1.15.88.122/melpa/")))
#+end_src

添加 straight 支持，主要是为了在 use-package 中使用。

#+begin_src emacs-lisp
  (defvar bootstrap-version)
  (let ((bootstrap-file
	 (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
	(bootstrap-version 6))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
	  (url-retrieve-synchronously
	   "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
	   'silent 'inhibit-cookies)
	(goto-char (point-max))
	(eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))

  ;; Set up use-package for tidier package configuration/installation
  (straight-use-package 'use-package)
  (setq straight-use-package-by-default t)
  (setq straight-vc-git-default-clone-depth 1)

  ;; Add diminish, which makes it easier to customize lighters (minor mode display)
  (use-package diminish)
#+end_src

* 函数定义
#+begin_src emacs-lisp
;; time date
(defun gcl/insert-standard-date ()
  "Inserts standard date time string."
  (interactive)
  (insert (format-time-string "%Y-%m-%d %T")))

(defun gcl/insert-changelog-date ()
  "Insert changelog date, like yyyy/mm/dd."
  (interactive)
  (insert (format-time-string "%Y/%m/%d")))

(defun gcl/insert-current-time ()
  "Insert current time, like hh:mm:ss."
  (interactive)
  (insert (format-time-string "%T")))

(defun gcl/open-current-directory ()
  (interactive)
  (consult-file-externally default-directory))
#+end_src

** buffer-move
FROM. [[https://github.com/manateelazycat/lazycat-emacs][manateelazycat/lazycat-emacs: Andy Stewart's emacs]]

#+begin_src emacs-lisp
(defun buf-move-up ()
  "Swap the current buffer and the buffer above the split.
If there is no split, ie now window above the current one, an
error is signaled."
;;  "Switches between the current buffer, and the buffer above the
;;  split, if possible."
  (interactive)
  (let* ((other-win (windmove-find-other-window 'up))
	 (buf-this-buf (window-buffer (selected-window))))
    (if (null other-win)
        (error "No window above this one")
      ;; swap top with this one
      (set-window-buffer (selected-window) (window-buffer other-win))
      ;; move this one to top
      (set-window-buffer other-win buf-this-buf)
      (select-window other-win))))

(defun buf-move-down ()
"Swap the current buffer and the buffer under the split.
If there is no split, ie now window under the current one, an
error is signaled."
  (interactive)
  (let* ((other-win (windmove-find-other-window 'down))
	 (buf-this-buf (window-buffer (selected-window))))
    (if (or (null other-win)
            (string-match "^ \\*Minibuf" (buffer-name (window-buffer other-win))))
        (error "No window under this one")
      ;; swap top with this one
      (set-window-buffer (selected-window) (window-buffer other-win))
      ;; move this one to top
      (set-window-buffer other-win buf-this-buf)
      (select-window other-win))))

(defun buf-move-left ()
"Swap the current buffer and the buffer on the left of the split.
If there is no split, ie now window on the left of the current
one, an error is signaled."
  (interactive)
  (let* ((other-win (windmove-find-other-window 'left))
	 (buf-this-buf (window-buffer (selected-window))))
    (if (null other-win)
        (error "No left split")
      ;; swap top with this one
      (set-window-buffer (selected-window) (window-buffer other-win))
      ;; move this one to top
      (set-window-buffer other-win buf-this-buf)
      (select-window other-win))))

(defun buf-move-right ()
"Swap the current buffer and the buffer on the right of the split.
If there is no split, ie now window on the right of the current
one, an error is signaled."
  (interactive)
  (let* ((other-win (windmove-find-other-window 'right))
	 (buf-this-buf (window-buffer (selected-window))))
    (if (null other-win)
        (error "No right split")
      ;; swap top with this one
      (set-window-buffer (selected-window) (window-buffer other-win))
      ;; move this one to top
      (set-window-buffer other-win buf-this-buf)
      (select-window other-win))))
#+end_src
** buffer-extension
#+begin_src emacs-lisp
(defun kill-other-window-buffer ()
  "Kill the buffer in other window."
  (interactive)
  (other-window +1)
  (kill-this-buffer)
  (other-window -1))
#+end_src
** git
#+begin_src emacs-lisp
(defun gcl/get-frame->selected-window ()
  "Returns a list of pairs of (frame selected-window)"
  (let* ((original-frame (window-frame))
         (result (->> (visible-frame-list)
                      (-map (lambda (f)
                              (select-frame f t)
                              (list f (selected-window)))))))
    (select-frame original-frame t)
    result))

(eval-when-compile
  (require 'cl))
(defun gcl/preserve-selected-window (f)
  "Runs the given function and then restores focus to the original window. Useful when you want to invoke
   a function (like showing documentation) but desire to keep your current window focused."
  ;; Note that we must preserve the selected window of every frame, because the function being executed may
  ;; change the focused frame, even if the current frame is in focus.
  (lexical-let* ((original-frame (selected-frame))
                 (frames->windows (gcl/get-frame->selected-window))
                 (result (funcall f)))
    (-each frames->windows (lambda (x)
                             (select-frame (first x) t)
                             (select-window (second x) t)))
    (select-frame-set-input-focus original-frame t)
    result))
#+end_src
* 便捷 Hacking
#+begin_src emacs-lisp
  (defun reload-init-file ()
    "Reload init file with <f5>."
    (interactive)
    (load-file "~/.emacs.d/init.el"))

  (setq custom-file (expand-file-name "custom.el" user-emacs-directory))
  (and (file-readable-p custom-file) (load custom-file))

  (defun gcl/open-init-file()
    (interactive)
    (find-file (expand-file-name "config.org" user-emacs-directory)))

  (global-set-key (kbd "<f5>") 'reload-init-file)
  (global-set-key (kbd "<f1>") 'gcl/open-init-file)
  (global-set-key (kbd "<f2>") 'restart-emacs)

  ;; 保存文件时自动生成配置到 init.el
  (use-package org-auto-tangle
    :hook (org-mode . org-auto-tangle-mode))

  (use-package auto-save
    :straight (:host github :repo "manateelazycat/auto-save")
    :config
    (auto-save-enable)
    (setq auto-save-silent t)
    (setq auto-save-delete-trailing-whitespace t)
    ;; 不想自动保存的文件后缀
    (setq auto-save-disable-predicates
	'((lambda ()
	(string-suffix-p
	"gpg"
	(file-name-extension (buffer-name)) t))))
    )
#+end_src

* 个人设置
#+begin_src emacs-lisp
(setq blog-admin-dir "~/github/mine/blog.cheng92.com/")
(setq user-full-name "Lee ZhiCheng"
      user-mail-address "gccll.love@gmail.com"
      user-blog-url "https://blog.cheng92.com"
      user-github-dir "~/github/mine/"
      user-web-dir "~/github/mine/gcl-web-system/"
      user-blog-dir (concat user-web-dir "apps/blog/")
      user-blog-public-dir (concat user-blog-dir "public/")
      user-blog-posts (concat user-blog-dir "/public/posts/")
      user-dot-dir "~/.gclrc/"
      user-dot-bin-dir "~/.gclrc/bin/"
      )
#+end_src
* 基础设置
#+begin_src emacs-lisp
  ;; 启动全屏
  (set-frame-parameter (selected-frame) 'fullscreen 'maximized)

  ;; 选中粘贴时能覆盖选中的内容
  (delete-selection-mode 1)
  ;; 高亮当前行
  (global-hl-line-mode 1)
  ;; 指针不闪动。
  (blink-cursor-mode -1)
  ;; 有些功能需要用到，比如：折叠等等
  (add-hook 'prog-mode-hook #'hs-minor-mode)
  ;; 选择是或否是用 y/n
  (fset 'yes-or-no-p 'y-or-n-p)
  ;; 默认显示 80 列就换行
  (setq default-fill-column 80)
  ;; 用一个很大的 kill ring. 这样防止我不小心删掉重要的东西
  (setq kill-ring-max 1024)
  ;; 设置的 mark ring 容量
  (setq mark-ring-max 1024)
  ;; 设置执行表达式的长度没有限制
  (setq eval-expression-print-length nil)
  ;; 设置执行表达式的深度没有限制
  (setq eval-expression-print-level nil)
  ;; 设置最大的全局标记容量
  (setq global-mark-ring-max 1024)
  ;; minibuffer 递归调用命令
  (setq enable-recursive-minibuffers t)
  ;; 删除minibuffer的重复历史
  (setq history-delete-duplicates t)
  ;; 显示消息超时的时间
  (setq minibuffer-message-timeout 1)
  ;; 自动更新 buffer
  (setq auto-revert-mode 1)
  ;; 括号匹配显示但不是烦人的跳到另一个括号。
  (setq show-paren-style 'parentheses)
  ;; 当插入右括号时显示匹配的左括号
  (setq blink-matching-paren t)
  ;; 不自动添加换行符到末尾, 有些情况会出现错误
  (setq require-final-newline nil)
  ;; 比较窗口设置在同一个 frame 里
  (setq ediff-window-setup-function (quote ediff-setup-windows-plain))
  ;; 设置传送文件默认的方法
  (setq tramp-default-method "ssh")
  ;; 禁止显示鼠标指针
  (setq void-text-area-pointer nil)
  ;; 当出现异常时弹出三角警告
  (setq visible-bell t)
  ;; 显示行尾空格
  (setq show-trailing-whitespace t)
  (setq create-lockfiles nil)

  ;; --- 关闭启动消息。
  (setq inhibit-startup-screen t)
  (setq inhibit-startup-message t)
  (setq inhibit-startup-echo-area-message t)
  (setq initial-scratch-message nil)
  ;; 改变 *scratch* buffer 的模式
  (setq initial-major-mode 'emacs-lisp-mode)
  (setq initial-buffer-choice t)
  ;; *scratch* buffer 初始显示的内容
  (setq initial-scratch-message "\
  ;; This buffer is for notes you don't want to save, and for Ruby code.
  ;; If you want to create a file, visit that file with C-x C-f,
  ;; then enter the text in that file's own buffer.")
#+end_src
* 性能设置
#+begin_src emacs-lisp
  (defun max-gc-limit ()
    (setq gc-cons-threshold most-positive-fixnum))

  (defun reset-gc-limit ()
    (setq gc-cons-threshold 800000))

  ;; 设置垃圾回收限制
  (add-hook 'minibuffer-setup-hook #'max-gc-limit)
  (add-hook 'minibuffer-exit-hook #'reset-gc-limit)
  (setq-default bidi-display-reordering nil)

  ;; 加速启动
  (setq auto-mode-case-fold nil)
  ;; 加快快捷键提示的速度
  (setq echo-keystrokes 0.1)

  ;; 提升 IO 性能。
  (setq process-adaptive-read-buffering nil)
  ;; 增加单次读取进程输出的数据量（缺省 4KB) 。
  (setq read-process-output-max (* 1024 1024))

  ;; 缩短 fontify 时间。
  (setq jit-lock-defer-time nil)
  (setq jit-lock-context-time 0.1)
  ;; 更积极的 fontify 。
  (setq fast-but-imprecise-scrolling nil)
  (setq redisplay-skip-fontification-on-input nil)

  ;; 缩短更新 screen 的时间。
  (setq idle-update-delay 0.1)

  ;; 使用字体缓存，避免卡顿。
  (setq inhibit-compacting-font-caches t)
  ;; 使用更瘦字体。
  (setq ns-use-thin-smoothing t)
  ;; 一次滚动一行，避免窗口跳动。
  (setq mouse-wheel-scroll-amount '(1 ((shift) . hscroll)))
  (setq mouse-wheel-scroll-amount-horizontal 1)
  (setq mouse-wheel-follow-mouse t)
  (setq mouse-wheel-progressive-speed nil)

  (defconst 1mb 1048576)
  (defconst 20mb 20971520)
  (defconst 30mb 31457280)
  (defconst 50mb 52428800)

  ;; lsp-mode's performance suggest
  (setq read-process-output-max (* 3 1mb))
#+end_src
* UI/主题/字体
#+begin_src emacs-lisp
(set-face-attribute 'default nil :height 140 :family "WenQuanYi Micro Hei Mono")

(use-package font-lock+
  :straight (:host github :repo "emacsmirror/font-lock-plus"))

(use-package all-the-icons)
(use-package all-the-icons-dired
  :hook ((dired-mode . all-the-icons-dired-mode)))

;; -- header line
(set-face-attribute 'header-line nil
                    :foreground (face-attribute 'mode-line :foreground)
                    :background (face-attribute 'mode-line :background)
                    ;; height of mode-line is also unspecified, so we set it directly.
                    :height 150
                    :box (face-attribute 'mode-line :box))

;; -- awesome tray
(use-package awesome-tray
  :straight (awesome-tray :type git :host github :repo "manateelazycat/awesome-tray")
  :config
  (setq awesome-tray-mode-line-height 0.1)
  ;; (setq-default awesome-tray-mode-line-default-height 0.1)
  (setq awesome-tray-mode-line-active-color "#EC4899")
  (setq awesome-tray-mode-line-inactive-color "#959eb1")
  (setq awesome-tray-active-modules '(
				      ;; "location"
				      "pdf-view-page"
				      "date"
				      "file-path"
				      "buffer-name"
				      "mode-name"
				      "battery"
				      "git"
				      "input-method"
				      "evil"
				      ;; "flymake"
				      "belong"
				      "anzu"
				      ;; "github"
				      ))
  (setq awesome-tray-date-format "%d/%H:%M:%S")

  (awesome-tray-mode 1))

;; -- highlight-parentheses
(use-package highlight-parentheses
  :hook (prog-mode . highlight-parentheses-mode)
  :config
  (add-hook 'minibuffer-setup-hook #'highlight-parentheses-minibuffer-setup)
  )

;; -- 丰富括号
(use-package rainbow-delimiters
  :hook (prog-mode-hook . rainbow-delimiters-mode))

#+end_src
* MiniBuffer

#+begin_src emacs-lisp
  (use-package marginalia
    :custom
    (marginalia-max-relative-age 0)
    (marginalia-align 'right)
    :init
    (marginalia-mode))

  (use-package all-the-icons-completion
    :after (marginalia all-the-icons)
    :hook (marginalia-mode . all-the-icons-completion-marginalia-setup)
    :init
    (all-the-icons-completion-mode))

  (use-package vertico
    ;; Special recipe to load extensions conveniently
    :straight (vertico :files (:defaults "extensions/*")
		       :includes (vertico-indexed
				  vertico-flat
				  vertico-grid
				  vertico-mouse
				  vertico-quick
				  vertico-buffer
				  vertico-repeat
				  vertico-reverse
				  vertico-directory
				  vertico-multiform
				  vertico-unobtrusive
				  ))
    ;; Make sure vertico state is saved for `vertico-repeat'
    :hook (minibuffer-setup . vertico-repeat-save)
    :custom
    (vertico-count 13)                    ; Number of candidates to display
    (vertico-resize t)
    (vertico-cycle nil) ; Go from last to first candidate and first to last (cycle)?
    :config
    (vertico-mode))
#+end_src

* Evil
#+begin_src emacs-lisp
  (use-package which-key
    :hook (after-init . which-key-mode)
    :ensure t
    :init
    (setq which-key-side-window-location 'bottom)
    (setq which-key-show-early-on-C-h t)
    (setq which-key-idle-delay 0.1)
    ;;(setq which-key-idle-secondary-delay 0.05)
    (which-key-mode)
    )

  (use-package evil
    :ensure t
    :init
    (evil-mode)
    :config
    ;; 退出编辑模式后光标留在原地
    (setq evil-move-cursor-back nil)
    ;; 让回车，TAB，空格键保持原来的功能
    (with-eval-after-load 'evil-maps
      (define-key evil-motion-state-map (kbd "RET") nil)
      (define-key evil-motion-state-map (kbd "TAB") nil)
      (define-key evil-motion-state-map (kbd "SPC") nil))
    (progn
      (setcdr evil-insert-state-map nil)
      (define-key evil-insert-state-map [escape] 'evil-normal-state)

      ;; --- 解绑一些按键
      (evil-global-set-key 'normal (kbd "c") nil)

      (setcdr evil-insert-state-map nil)
      (define-key evil-insert-state-map [escape] 'evil-normal-state)
      (setq-default evil-ex-search-persistent-highlight nil)

      (define-key evil-motion-state-map (kbd "0") 'evil-end-of-line)

      (evil-global-set-key 'normal "f" 'evil-avy-goto-char)
      (evil-global-set-key 'normal "w" 'evil-avy-goto-word-1)
      (evil-global-set-key 'motion "-" 'org-decrease-number-at-point)
      (evil-global-set-key 'motion "+" 'org-increase-number-at-point)

      (evil-global-set-key 'normal (kbd "gd") 'xref-find-definitions)
      (evil-global-set-key 'normal (kbd "gb") 'xref-pop-marker-stack)
      (evil-global-set-key 'normal (kbd "gc") 'show-commit-and-preserve-window)

      (evil-global-set-key 'normal (kbd "cc") 'evilnc-copy-and-comment-lines)
      )
    )

  (use-package evil-nerd-commenter
    :ensure t)
#+end_src

在一些模式中关闭 evil-mode:

#+begin_src emacs-lisp
;; (evil-set-initial-state 'color-rg-mode 'emacs)
;; (evil-set-initial-state 'multi-vterm-mode 'emacs)
;; (evil-set-initial-state 'vterm-mode 'emacs)
;; (evil-set-initial-state 'magit-mode 'emacs)
;; (evil-set-initial-state 'dired-mode 'emacs)
;; (evil-set-initial-state 'magit-branch-manager-mode 'emacs)
#+end_src

* General
#+begin_src emacs-lisp
(use-package general)
#+end_src
** Fn
#+begin_src emacs-lisp
(general-define-key
 ;; "<f2>" 'restart-emacs
 )
#+end_src

** 逗号前缀

#+begin_src emacs-lisp
(general-create-definer global-leader
  :keymaps 'override
  :states '(emacs normal hybrid motion visual operator)
  :prefix ","
  "" '(:ignore t :which-key (lambda (arg) `(,(cadr (split-string (car arg) " ")) . ,(replace-regexp-in-string "-mode$" "" (symbol-name major-mode))))))

(global-leader
  ;; "c" 'blamer-show-posframe-commit-info
  )
#+end_src

** SPC 空格

#+begin_src emacs-lisp
  (general-create-definer global-definer
    :keymaps 'override
    :states '(insert emacs normal hybrid motion visual operator)
    :prefix "SPC"
    :non-normal-prefix "C-SPC")

  (global-definer
   ;; "TAB" 'projectile-persp-switch-project
   "SPC" 'execute-extended-command
   "0" 'select-window-0
   "1" 'select-window-1
   "2" 'select-window-2
   "3" 'select-window-3
   "," 'delete-window
   "." 'kill-this-buffer
   ";" 'kill-other-window-buffer
   "x" 'switch-to-scratch-buffer
   "`" 'multi-vterm-project
   )

  ;; 可以定制 SPC <key1> <key2> ...
  (defmacro +general-global-menu! (name infix-key &rest body)
    "Create a definer named +general-global-NAME wrapping global-definer.
    Create prefix map: +general-global-NAME. Prefix bindings in BODY with INFIX-KEY."
    (declare (indent 2))
    `(progn
       (general-create-definer ,(intern (concat "+general-global-" name))
	 :wrapping global-definer
	 :prefix-map ',(intern (concat "+general-global-" name "-map"))
	 :infix ,infix-key
	 :wk-full-keys nil
	 "" '(:ignore t :which-key ,name))
       (,(intern (concat "+general-global-" name))
	,@body)))
#+end_src

*** SPC a 应用类
#+begin_src emacs-lisp
  (+general-global-menu! "apps" "a"
			 "a" 'org-agenda
			 "c" 'agenda)
#+end_src

*** SPC b Buffer 相关

#+begin_src emacs-lisp
  (+general-global-menu! "buffer" "b"
			 "b" 'consult-buffer
			 "o" 'consult-buffer-other-window
			 "p" 'previous-buffer
			 "n" 'next-buffer
			 "k" 'kill-buffer
			 "d" 'kill-current-buffer
			 "i" 'ibuffer
			 "r" 'crux-rename-buffer-and-file
			 "x" 'crux-kill-other-buffers
			 "f" 'gcl/open-current-directory
			 )
#+end_src

*** SPC f 文件相关

#+begin_src emacs-lisp
  (+general-global-menu! "files" "f"
			 "o" 'crux-open-with
			 "p" 'consult-find
			 "f" 'find-file
			 "d" 'crux-delete-file-and-buffer
			 "r" 'crux-rename-file-and-buffer
			 )
#+end_src

*** SPC l 加载或链接相关

#+begin_src emacs-lisp
  (+general-global-menu! "load&link" "l"
			 ;; test: https://blog.cheng92.com
			 ;; "o" 'link-hint-open-link
			 ;; "c" 'link-hint-copy-link
			 )
#+end_src

*** SPC p 项目相关

#+begin_src emacs-lisp
  (+general-global-menu! "projects" "p"
			 ;; "p" 'consult-projectile-switch-project
			 ;; "f" 'consult-projectile-find-file
			 ;; "d" 'consult-projectile-find-dir
			 ;; "b" 'consult-projectile-switch-to-buffer
			 ;; "B" 'consult-project-buffer
			 )
#+end_src

*** SPC q 查询相关

#+begin_src emacs-lisp
  (+general-global-menu! "query" "q"
			 ;; "r" 'restart-emacs
			 )
#+end_src

*** SPC s 搜索相关

#+begin_src emacs-lisp
  (+general-global-menu! "search" "s"
			 ;; "p" 'consult-ripgrep
			 ;; "i" 'color-rg-search-input
			 ;; "I" 'color-rg-search-input-in-project
			 ;; "s" 'color-rg-search-symbol
			 ;; "S" 'color-rg-search-symbol-in-project
			 )
#+end_src

*** SPC w 窗口相关

#+begin_src emacs-lisp
  (+general-global-menu! "window" "w"
			 "," 'delete-window
			 "-" 'split-window-below
			 "v" 'split-window-right
			 "m" 'delete-other-windows
			 "h" 'evil-window-left
			 "l" 'evil-window-right
			 "j" 'evil-window-down
			 "k" 'evil-window-up)
#+end_src

** 组合按键
*** Control 组合键(C)
#+begin_src emacs-lisp
  (general-define-key
   ;; "C-;" 'embark-act
   "C-=" 'er/expand-region
   ;; "C-a" 'crux-move-beginning-of-line
   "C-r" 'crux-rename-buffer-and-file
   "C-j" 'emmet-expand-yas
   "C-s" 'consult-line
   "C-'" 'toggle-quotes-plus
   "C-`" 'vterm-toggle
   "C-w" 'evil-delete-backward-word
   "C-p" 'previous-line
   "C-S-h" 'buf-move-left
   "C-S-l" 'buf-move-right
   "C-S-j" 'buf-move-down
   "C-S-k" 'buf-move-up
   "C-S-o" 'duplicate-line-or-region-above
   "C-S-n" 'duplicate-line-or-region-below

   ;; C-c
   ;; 1 + 2 + 3
   ;; "C-c =" 'math-at-point
   ;; C-c f  -> hydra-lsp/body
   "C-c b" 'consult-bookmark
   "C-c h" 'consult-history
   "C-c o" 'consult-outline
   "C-c y" 'fanyi-dwim2
   "C-c t" 'gcl/insert-current-time
   "C-c d" 'gcl/insert-standard-date
   ;; "C-c c" 'copy-buffer-file-name-as-kill
   "C-c i" 'org-mac-link-get-link
   "C-c e" 'consult-flycheck
   ;; "C-c r" 'vr/replace
   ;; "C-c q" 'vr/query-replace
   ;; "C-c m" 'vr/mc-mark
   ;; "C-c u" 'uuidgen
   )
#+end_src

*** Command 组合键(s)

#+begin_src emacs-lisp
  (general-define-key
   "<s-backspace>" 'crux-kill-line-backwards
   "<s-left>" 'windmove-left
   "<s-right>" 'windmove-right
   "<s-down>" 'windmove-down
   "<s-up>" 'windmove-up
   "s-," 'bury-buffer
   "s-." 'unbury-buffer
   "s-<" 'watch-other-window-up-line
   "s->" 'watch-other-window-down-line
   ;; "s-0" 'sp-splice-sexp
   "s-p" 'move-text-up
   "s-n" 'move-text-down
   "s-m" 'toggle-input-method
   "s-o" 'toggle-one-window
   "s-R" 're-builder
   ;; "s-i" 'gcl/string-inflection-cycle-auto
   "s-d" 'consult-dir
   ;; "s-F" 'format-all-buffer
   ;; "s-h" 'gcl/urls/body
   ;; "s-`" 'vterm-toggle
   "s-'" 'vertico-repeat

   ;; s-g
   "s-g" nil
   "s-g o" 'consult-outline
   "s-g m" 'consult-mark
   "s-g k" 'consult-global-mark
   "s-g i" 'consult-yasnippet
   )
#+end_src

*** Option/Alt 组合键(M)

#+begin_src emacs-lisp
  (general-define-key
   ;; M, Option/Alt
   "M-s" 'symbol-overlay-put
   "M-n" 'symbol-overlay-switch-forward
   "M-p" 'symbol-overlay-switch-backward
   "M-c" 'symbol-overlay-remove-all
   ;; "M-*" 'tempel-insert
   ;; "M-+" 'tempel-complete
   "M-'" 'consult-register-store
   "M-#" 'consult-register-load
   "M-;" 'evilnc-comment-or-uncomment-lines
   ;; "M-e" 'emojify-insert-emoji
   ;; "M-d" 'dash-at-point
   ;; "M-j" 'rime-inline-ascii
   "M-i" 'consult-imenu
   ;; "M-m" 'blamer-show-posframe-commit-info
   )
#+end_src

* snippets
** abbrevs
#+begin_src emacs-lisp
(setq save-abbrevs nil)
(setq-default abbrev-mode t)
(define-abbrev-table
  'global-abbrev-table '(
			 ;; signature
			 ("8zc" "lizhicheng")
			 ("8zj" "李志诚")
			 ("8lp" "范婷婷")
			 ;; Microsoft
			 ("8ms" "Microsoft")
			 ("8em" "gccll.love@gmail.com")
			 ("8bl" "https://blog.cheng92.com")
			 ))

#+end_src
** dabbrevs
#+begin_src emacs-lisp
(use-package dabbrev
    ;; Swap M-/ and C-M-/
    :bind (("M-/" . dabbrev-completion)
	   ("C-M-/" . dabbrev-expand))
    ;; Other useful Dabbrev configurations.
    :custom
    (dabbrev-ignored-buffer-regexps '("\\.\\(?:pdf\\|jpe?g\\|png\\)\\'")))
#+end_src
** fancy-dabbrev
#+begin_src emacs-lisp
(use-package fancy-dabbrev
  :ensure t
  :config
  (global-fancy-dabbrev-mode)
  ;; Bind fancy-dabbrev-expand and fancy-dabbrev-backward to your keys of
  ;; choice, here "TAB" and "Shift+TAB":
  (global-set-key (kbd "M-/") 'fancy-dabbrev-expand)
  (global-set-key (kbd "M-?") 'fancy-dabbrev-backward)

  ;; If you want TAB to indent the line like it usually does when the cursor
  ;; is not next to an expandable word, use 'fancy-dabbrev-expand-or-indent
  ;; instead of `fancy-dabbrev-expand`:
  ;; (global-set-key (kbd "TAB") 'fancy-dabbrev-expand-or-indent)
  ;; (global-set-key (kbd "<backtab>") 'fancy-dabbrev-backward)
  ;; Let dabbrev searches ignore case and expansions preserve case:
  (setq dabbrev-case-distinction nil)
  (setq dabbrev-case-fold-search t)
  (setq dabbrev-case-replace nil)
  )
#+end_src
* bookmarks
#+begin_src emacs-lisp
;; 有变化时自动保存
(setq bookmark-save-flag 1)
#+end_src
* 文字编辑
** expand-region
#+begin_src emacs-lisp
(use-package expand-region)
#+end_src
** smartparens
#+begin_src emacs-lisp
(use-package smartparens
  :diminish smartparens-mode
  :bind
  (:map smartparens-mode-map
        ("C-M-f" . sp-forward-sexp)
        ("C-M-b" . sp-backward-sexp)
        ("C-M-k" . sp-kill-sexp)
        ("C-M-w" . sp-copy-sexp)
	:map smartparens-strict-mode-map
        ("C-M-<backspace>" . sp-backward-unwrap-sexp)
        ("C-M-d" . sp-unwrap-sexp))
  :hook
  ((prog-mode . smartparens-mode)
   ;; (smartparens-mode . smartparens-strict-mode)
   )
  :config (require 'smartparens-config))
#+end_src

** hungry-delete
#+begin_src emacs-lisp
(use-package autorevert
  :diminish
  :hook (after-init . global-auto-revert-mode))
(use-package hungry-delete
  :diminish
  :hook (after-init . global-hungry-delete-mode)
  :config (setq-default hungry-delete-chars-to-skip " \t\f\v"))
#+end_src
** symbol-overlay
#+begin_src emacs-lisp
(use-package symbol-overlay)
#+end_src
** move-text
#+begin_src emacs-lisp
(use-package move-text)
#+end_src
** editorconfig
#+begin_src emacs-lisp
(use-package editorconfig
  :config
  (editorconfig-mode 1))
#+end_src
** toggle-quotes-plus
#+begin_src emacs-lisp
(use-package toggle-quotes-plus
  :straight (:host github :repo "jcs-elpa/toggle-quotes-plus")
  :config
  (setq toggle-quotes-plus-chars '("\""
                                 "'"
                                 "`")))
#+end_src
* 工具类
** crux
#+begin_src emacs-lisp
(use-package crux)
#+end_src
** fanyi
#+begin_src emacs-lisp
(use-package fanyi
  :config
  (custom-set-variables
   '(fanyi-providers '(fanyi-haici-provider
                       fanyi-youdao-thesaurus-provider
                       fanyi-etymon-provider
                       fanyi-longman-provider
                       fanyi-libre-provider)))

  ;; 还要自动选择翻译内容 buffer
  (setq fanyi-auto-select nil))

#+end_src
* 开发设置

node 包路径：

#+begin_src emacs-lisp
(setenv "NODE_PATH" "/usr/local/lib/node_modules")
#+end_src

** editorconfig
#+begin_src emacs-lisp
(use-package editorconfig
  :config
  (editorconfig-mode 1))
#+end_src
** orderless

#+begin_src emacs-lisp
  ;; Optionally use the `orderless' completion style.
  (use-package orderless
    :init
    ;; Configure a custom style dispatcher (see the Consult wiki)
    ;; (setq orderless-style-dispatchers '(+orderless-dispatch)
    ;;       orderless-component-separator #'orderless-escapable-split-on-space)
    (setq completion-styles '(orderless-fast)
	  completion-category-defaults nil
	  completion-category-overrides '((file (styles . (partial-completion)))))


    :config
    (defun orderless-fast-dispatch (word index total)
      (and (= index 0) (= total 1) (length< word 4)
	   `(orderless-regexp . ,(concat "^" (regexp-quote word)))))

    (orderless-define-completion-style orderless-fast
      (orderless-style-dispatchers '(orderless-fast-dispatch))
      (orderless-matching-styles '(orderless-literal orderless-regexp)))
    )


#+end_src

** corfu

#+begin_src emacs-lisp
  (use-package corfu
    :after orderless
    ;; Optional customizations
    :custom
    (corfu-cycle t)                ;; Enable cycling for `corfu-next/previous'
    (corfu-auto t)                 ;; Enable auto completion
    (corfu-quit-at-boundary nil)     ;; Automatically quit at word boundary
    (corfu-quit-no-match t)        ;; Automatically quit if there is no match
    (corfu-auto-delay 0)
    ;; 输入两个字符开始实例
    (corfu-auto-prefix 2)
    ;; (corfu-separator ?\s)          ;; Orderless field separator
    (corfu-preview-current nil)    ;; Disable current candidate preview
    (corfu-preselect-first t)    ;; Enable candidate preselection
    ;; (corfu-on-exact-match nil)     ;; Configure handling of exact matches
    ;; (corfu-echo-documentation nil) ;; Disable documentation in the echo area
    ;; (corfu-scroll-margin 5)        ;; Use scroll margin
    ;; (corfu-min-width 80)
    (corfu-max-width 80)
    :bind
    (:map corfu-map
	  ("C-j" . corfu-next)
	  ("C-k" . corfu-previous)
	  ("<escape>" . corfu-quit)
	  ;; ("M-l" . corfu-show-location)
	  ;; ("M-d" . corfu-show-documentation)
	  )
    :init
    (global-corfu-mode)
    :config
    (defun corfu-enable-always-in-minibuffer ()
      "Enable Corfu in the minibuffer if Vertico/Mct are not active."
      (unless (or (bound-and-true-p mct--active)
		  (bound-and-true-p vertico--input))
	;; (setq-local corfu-auto nil) Enable/disable auto completion
	(corfu-mode 1)))
    (add-hook 'minibuffer-setup-hook #'corfu-enable-always-in-minibuffer 1)
    )

  (use-package kind-icon
    :after corfu
    :custom
    (kind-icon-use-icons t)
    (kind-icon-default-face 'corfu-default) ; Have background color be the same as `corfu' face background
    (kind-icon-blend-background nil)  ; Use midpoint color between foreground and background colors ("blended")?
    (kind-icon-blend-frac 0.08)
    :config
    (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter) ; Enable `kind-icon'
    )

  (use-package corfu-doc
    ;; NOTE 2022-02-05: At the time of writing, `corfu-doc' is not yet on melpa
    :straight (corfu-doc :type git :host github :repo "galeo/corfu-doc")
    :after corfu
    :hook (corfu-mode . corfu-doc-mode)
    :bind
    (:map corfu-map
	  ("M-n" . corfu-doc-scroll-up)
	  ("M-p" . corfu-doc-scroll-down))
    :custom
    (corfu-doc-delay 0.5)
    (corfu-doc-max-width 70)
    (corfu-doc-max-height 20)

    ;; NOTE 2022-02-05: I've also set this in the `corfu' use-package to be
    ;; extra-safe that this is set when corfu-doc is loaded. I do not want
    ;; documentation shown in both the echo area and in the `corfu-doc' popup.
    (corfu-echo-documentation nil))

  ;; A few more useful configurations...
  (use-package emacs
    :init
    (setq completion-cycle-threshold 2)
    (setq tab-always-indent 'complete))
#+end_src

** lsp-mode

#+begin_src emacs-lisp
  (use-package lsp-mode
    :init
    ;; set prefix for lsp-command-keymap (few alternatives - "C-l", "C-c l")
    (setq lsp-keymap-prefix "C-c l")
    :hook ((js2-mode . lsp)
	   (web-mode . lsp)
	   (typescript-mode . lsp)
	   ;; if you want which-key integration
	   (lsp-mode . lsp-enable-which-key-integration))
    :custom
    (lsp-completion-provider :none)
    :commands lsp
    :config
    (setq lsp-disabled-clients '(vls))
    ;; (setq lsp-enabled-clients '(lsp-volar))
    )


  (use-package lsp-ui :commands lsp-ui-mode)
  (use-package lsp-treemacs :commands lsp-treemacs-errors-list)
  (use-package lsp-tailwindcss
    :init
    (setq lsp-tailwindcss-add-on-mode t)
    (setq lsp-tailwindcss-major-modes
	  '(svelte-mode html-mode sgml-mode mhtml-mode web-mode css-mode js-mode))
    (add-hook 'before-save-hook 'lsp-tailwindcss-rustywind-before-save)
    )

  (use-package lsp-volar
    :straight (:host github :repo "jadestrong/lsp-volar"))

  (global-set-key (kbd "C-c l s") 'lsp-tailwindcss-rustywind)
  (global-set-key (kbd "C-c l i") 'lsp-ui-imenu)
  (global-set-key (kbd "C-c l d") 'lsp-ui-peek-find-definitions)
  (global-set-key (kbd "C-c l r") 'lsp-ui-peek-find-references)
  (global-set-key (kbd "C-c l a") 'lsp-organize-imports)
#+end_src

** web-mode

#+begin_src emacs-lisp
  (use-package dap-mode
    :hook ((lsp-mode . dap-mode)
	   (lsp-mode . dap-ui-mode))
    :bind (:map dap-mode-map
		("C-c d d" . dap-debug)
		("C-c d h" . dap-hydra)
		("C-c d b" . dap-ui-breakpoints)
		("C-c d l" . dap-ui-locals)
		("C-c d r" . dap-ui-repl)))

  (defun my/setup-js-mode ()
    (require 'dap-chrome)
    (setq tab-width 2)
    ;; 由于 lsp 已经提供了 diagnose 功能，故关闭 js2 自带的错误检查，防止干扰。
    (setq js2-mode-show-strict-warnings nil)
    (setq js2-mode-show-parse-errors nil))

  (use-package js2-mode
    :ensure t
    :after (lsp-mode dap-mode)
    :mode "\\.js\\'"
    :hook ((js2-mode . my/setup-js-mode)))

  (use-package typescript-mode
    :ensure t
    :after (lsp-mode dap-mode)
    :mode ("\\.ts\\'" "\\.tsx\\'")
    :hook ((typescript-mode . my/setup-js-mode)))

  (use-package json-mode
    :ensure t
    :mode "\\.json\\'")

  (use-package css-mode)
  (use-package scss-mode)
  (use-package emmet-mode
    :hook ((sgml-mode html-mode css-mode web-mode) . emmet-mode)
    :config
    (add-hook 'emmet-mode-hook (lambda () (setq emmet-indentation 2))) ;; indent 2 spaces.
    )

  (use-package web-mode
    :mode
    (
     ".twig$"
     ".html?$"
     ".hbs$"
     ".vue$"
     ".blade.php$"
     )
    :config
    (setq
     web-mode-markup-indent-offset 2
     web-mode-css-indent-offset 2
     web-mode-code-indent-offset 2
     web-mode-style-padding 0
     web-mode-script-padding 0
     web-mode-enable-auto-closing t
     web-mode-enable-auto-opening t
     web-mode-enable-auto-pairing nil
     web-mode-enable-auto-indentation t
     web-mode-tag-auto-close-style 1
     web-mode-enable-current-element-highlight t)

    ;; Let smartparens handle auto closing brackets, e.g. {{ }} or {% %}
    ;; https://github.com/hlissner/doom-emacs/blob/develop/modules/lang/web/%2Bhtml.el#L56
    (dolist (alist web-mode-engines-auto-pairs)
      (setcdr alist
	      (cl-loop for pair in (cdr alist)
		       unless (string-match-p "^[a-z-]" (cdr pair))
		       collect (cons (car pair)
				     (string-trim-right (cdr pair)
							"\\(?:>\\|]\\|}\\)+\\'")))))
    )

  (defun gcl/web-maybe-activate-lsp ()
    "Maybe activate language server protocol for the current buffer."
    (if (equal (gf/filename-extension (buffer-file-name)) "vue")
	(lsp-vue-mmm-enable)))
#+end_src
** lsp-hydra

#+begin_src emacs-lisp
(use-package hydra)
#+end_src
* 版本管理
** magit
#+begin_src emacs-lisp
(use-package magit
  :ensure t
  :config
  ;; 提交时候不显示提交细节
  (setq magit-commit-show-diff nil)
  ;; 没有焦点时候不刷新状态
  (setq magit-refresh-status-buffer nil)
  ;; 当前buffer打开magit
  (setq magit-display-buffer-function
	(lambda (buffer)
          (display-buffer buffer '(display-buffer-same-window))))
  (setq magit-ellipsis (get-byte 0 "."))
  ;; 加速diff
  (setq magit-revision-insert-related-refs nil)
  (defun show-commit-and-preserve-window ()
    (interactive)
    ;; NOTE(philc): I'm not sure why magit-show-commit needs to be called interactively, but just invoking it
    ;; directly gives an argument error.
    (gcl/preserve-selected-window (lambda ()
                                    (call-interactively 'magit-show-commit))))
  (setq magit-diff-refine-hunk t)
  (setq magit-diff-paint-whitespace nil)
  (setq magit-ediff-dwim-show-on-hunks t)
  (setq magit-display-buffer-function
	(lambda (buffer)
	  (display-buffer buffer '(display-buffer-same-window))))
  ;; 加速diff
  (setq magit-revision-insert-related-refs nil)
  )
#+end_src
* org-mode

*bold* _underline_ +delete+ /italic/

#+begin_src emacs-lisp
(with-eval-after-load 'org
  (progn
    (setq org-directory "~/.gclrc/org/")

    ;; -- basic
    (setq org-startup-indented t
          org-pretty-entities t
          org-hide-emphasis-markers t
          org-startup-with-inline-images t
          org-image-actual-width '(300)
          org-html-doctype "html5")

    ;; -- 使用 “+” 来切换列表风格，- -> 1. -> a. ...
    (evil-define-key 'normal org-mode-map
      "+" #'org-cycle-list-bullet)

    ;; -- keywords
    (setq org-todo-keywords
          (quote ((sequence "TODO(t)" "STARTED(s)" "|" "DONE(d!/!)")
                  (sequence "WAITING(w@/!)" "SOMEDAY(S)" "|" "CANCELLED(c@/!)" "MEETING(m)" "PHONE(p)"))))

    ;; -- paint
    (setq org-plantuml-jar-path "~/.gclrc/plantuml.jar")
    (setq org-ditaa-jar-path "~/.gclrc/ditaa.jar")


    ;; -- emphasis 设置
    (setq org-emphasis-alist
          '(("*" my-org-emphasis-bold)
            ("/" my-org-emphasis-italic)
            ("_" underline)
            ("=" org-verbatim verbatim)
            ("~" org-code verbatim)
            ("+" (:strike-through t))))
    (defface my-org-emphasis-bold
      '((default :inherit bold)
        (((class color) (min-colors 88) (background light))
         :foreground "#a60000")
        (((class color) (min-colors 88) (background dark))
         :foreground "#ff8059"))
      "My bold emphasis for Org.")

    (defface my-org-emphasis-italic
      '((default :inherit italic)
        (((class color) (min-colors 55) (background light))
         :foreground "#972500")
        (((class color) (min-colors 55) (background dark))
         :foreground "#ef8b50"))
      "My italic emphasis for Org.")

    ;; Allow multiple line Org emphasis markup.
    ;; http://emacs.stackexchange.com/a/13828/115
    (setcar (nthcdr 4 org-emphasis-regexp-components) 20) ;Up to 20 lines, default is just 1
    ;; Below is needed to apply the modified `org-emphasis-regexp-components'
    ;; settings from above.
    (org-set-emph-re 'org-emphasis-regexp-components org-emphasis-regexp-components)

    ;; ------------- end --------------
    )
  )
#+end_src

** org-agenda

#+begin_src emacs-lisp
  (use-package org-super-agenda
    :config
    (defvar org-agenda-dir ""
      "gtd org files location")

    (defvar deft-dir ""
      "deft org files locaiton")

    (setq org-agenda-dir "~/.gclrc/org/")
    (setq deft-dir  "~/.gclrc/org/")
    (setq org-agenda-log-mode-items '(clock closed state))

    (setq org-agenda-inhibit-startup t) ;; ~50x speedup
    (setq org-agenda-span 'day)
    (setq org-agenda-use-tag-inheritance nil) ;; 3-4x speedup
    (setq org-agenda-window-setup 'current-window)
    (setq org-log-done t)
    (setq org-columns-default-format "%60ITEM(Task) %6Effort(Estim){:}")

    (setq org-agenda-file-note (expand-file-name "notes.org" org-agenda-dir))
    (setq org-agenda-file-gtd (expand-file-name "gtd.org" org-agenda-dir))
    (setq org-agenda-file-work (expand-file-name "work.org" org-agenda-dir))
    (setq org-agenda-file-journal (expand-file-name "journal.org" org-agenda-dir))
    (setq org-agenda-file-code-snippet (expand-file-name "snippet.org" org-agenda-dir))
    (setq org-default-notes-file (expand-file-name "gtd.org" org-agenda-dir))
    (setq org-agenda-file-blogposts (expand-file-name "all-posts.org" org-agenda-dir))
    (setq org-agenda-files (list org-agenda-file-gtd org-agenda-file-journal org-agenda-file-blogposts org-agenda-file-work org-agenda-file-note))
    )
#+end_src

** svg-tag-mode

<2022-10-30 10:00> [2022-10-30 10:00] [2022-10-30 Tue 10:00]

[1/3] [30%]

TODO DONE WORK FIXME

[ ] [x] (0) (1) (2) (3) (4) (5) (6) (7) (8) (9) (a) (b) ... (z)

[#A] [#B] [#C] [#D] [#E]

:#TAG :#TAG1:#TAG2

#+begin_src emacs-lisp
  (use-package svg-tag-mode
    :after org
    :hook (org-mode . svg-tag-mode)
    :config
    (defun mk/svg-checkbox-empty ()
      (let* ((svg (svg-create 14 14)))
        (svg-rectangle svg 0 0 14 14 :fill 'white :rx 2 :stroke-width 2.5 :stroke-color 'black)
        (svg-image svg :ascent 'center)))

    (defun mk/svg-checkbox-filled ()
      (let* ((svg (svg-create 14 14)))
        (svg-rectangle svg 0 0 14 14 :fill "#FFFFFF" :rx 2)
        (svg-polygon svg '((5.5 . 11) (12 . 3.5) (11 . 2) (5.5 . 9) (1.5 . 5) (1 . 6.5))
                     :stroke-color 'black :stroke-width 1 :fill 'black)
        (svg-image svg :ascent 'center)))

    (defun mk/svg-checkbox-toggle ()
      (interactive)
      (save-excursion
        (let* ((start-pos (line-beginning-position))
               (end-pos (line-end-position))
               (text (buffer-substring-no-properties start-pos end-pos))
               (case-fold-search t)       ; Let X and x be the same in search
               )
          (beginning-of-line)
          (cond ((string-match-p "\\[X\\]" text)
                 (progn
                   (re-search-forward "\\[X\\]" end-pos)
                   (replace-match "[ ]")))
                ((string-match-p "\\[ \\]" text)
                 (progn
                   (search-forward "[ ]" end-pos)
                   (replace-match "[X]")))))))

    (defun svg-progress-percent (value)
      (svg-image (svg-lib-concat
                  (svg-lib-progress-bar (/ (string-to-number value) 100.0)
                                        nil :margin 0 :stroke 2 :radius 3 :padding 2 :width 11)
                  (svg-lib-tag (concat value "%")
                               nil :stroke 0 :margin 0)) :ascent 'center))

    (defun svg-progress-count (value)
      (let* ((seq (mapcar #'string-to-number (split-string value "/")))
             (count (float (car seq)))
             (total (float (cadr seq))))
        (svg-image (svg-lib-concat
                    (svg-lib-progress-bar (/ count total) nil
                                          :margin 0 :stroke 2 :radius 3 :padding 2 :width 11)
                    (svg-lib-tag value nil
                                 :stroke 0 :margin 0)) :ascent 'center)))

    (defconst date-re "[0-9]\\{4\\}-[0-9]\\{2\\}-[0-9]\\{2\\}")
    (defconst time-re "[0-9]\\{2\\}:[0-9]\\{2\\}")
    (defconst day-re "[A-Za-z]\\{3\\}")
    (defconst day-time-re (format "\\(%s\\)? ?\\(%s\\)?" day-re time-re))

    (setq svg-tag-tags
          `(
            ;; -- Number
            ("\([0-9a-zA-Z]\)" . ((lambda (tag)
                                    (svg-tag-make tag :beg 1 :end -1 :radius 12))))
            ;; -- Task priority
            ("\\[#[A-Z]\\]" . ((lambda (tag)
                                 (svg-tag-make tag :face 'org-priority
                                               :beg 2 :end -1 :margin 0))))
            ;; -- Tags
            ("\\(:#[A-Za-z0-9]+\\)" . ((lambda (tag)
                                         (svg-tag-make tag :beg 2))))
            ("\\(:#[A-Za-z0-9]+:\\)$" . ((lambda (tag)
                                           (svg-tag-make tag :beg 2 :end -1))))

            ;; -- Progress
            ("\\(\\[[0-9]\\{1,3\\}%\\]\\)" . ((lambda (tag)
                                                (svg-progress-percent (substring tag 1 -2)))))
            ("\\(\\[[0-9]+/[0-9]+\\]\\)" . ((lambda (tag)
                                              (svg-progress-count (substring tag 1 -1)))))

            ;; -- Checkbox
            ("\\[ \\]" . ((lambda (_tag) (mk/svg-checkbox-empty))
                          (lambda () (interactive) (mk/svg-checkbox-toggle))
                          "Click to toggle."))
            ("\\(\\[[Xx]\\]\\)" . ((lambda (_tag) (mk/svg-checkbox-filled))
                                   (lambda () (interactive) (mk/svg-checkbox-toggle))
                                   "Click to toggle."))

            ;; -- Date: Active date (with or without day name, with or without time)
            (,(format "\\(<%s>\\)" date-re) .
             ((lambda (tag)
                (svg-tag-make tag :beg 1 :end -1 :margin 0))))
            (,(format "\\(<%s \\)%s>" date-re day-time-re) .
             ((lambda (tag)
                (svg-tag-make tag :beg 1 :inverse nil :crop-right t :margin 0))))
            (,(format "<%s \\(%s>\\)" date-re day-time-re) .
             ((lambda (tag)
                (svg-tag-make tag :end -1 :inverse t :crop-left t :margin 0))))

            ;; -- Date: Inactive date  (with or without day name, with or without time)
            (,(format "\\(\\[%s\\]\\)" date-re) .
             ((lambda (tag)
                (svg-tag-make tag :beg 1 :end -1 :margin 0 :face 'org-date))))
            (,(format "\\(\\[%s \\)%s\\]" date-re day-time-re) .
             ((lambda (tag)
                (svg-tag-make tag :beg 1 :inverse nil :crop-right t :margin 0 :face 'org-date))))
            (,(format "\\[%s \\(%s\\]\\)" date-re day-time-re) .
             ((lambda (tag)
                (svg-tag-make tag :end -1 :inverse t :crop-left t :margin 0 :face 'org-date))))

            ;; Keywords
            ;; ("TODO" . ((lambda (tag) (svg-tag-make tag :height 0.8 :inverse t
            ;;                                        :face 'org-todo :margin 0 :radius 5))))
            ;; ("WORK" . ((lambda (tag) (svg-tag-make tag :height 0.8
            ;;                                        :face 'org-todo :margin 0 :radius 5))))
            ;; ("DONE" . ((lambda (tag) (svg-tag-make tag :height 0.8 :inverse t
            ;;                                        :face 'org-done :margin 0 :radius 5))))

            ("FIXME\\b" . ((lambda (tag) (svg-tag-make "FIXME" :face 'org-todo :inverse t :margin 0 :crop-right t))))
            ("DONE\\b" . ((lambda (tag) (svg-tag-make "DONE" :face 'org-done :inverse t :margin 0 :crop-right t))))
            ("TODO\\b" . ((lambda (tag) (svg-tag-make "TODO" :face 'org-tag :inverse t :margin 0 :crop-right t))))
            ("WORK\\b" . ((lambda (tag) (svg-tag-make "WORK" :face 'org-todo :inverse t :margin 0 :crop-right t))))
            ))
    )
#+end_src

** org-block

#+begin_src emacs-lisp
  (with-eval-after-load 'org
    (progn
      (require 'org-tempo)
      (require 'org-src)
      (add-hook 'org-babel-after-execute-hook #'org-redisplay-inline-images)
      (setq org-confirm-babel-evaluate nil
            org-src-fontify-natively t
            org-src-tab-acts-natively t
            org-src-preserve-indentation t
            ;; or current-window
            org-src-window-setup 'other-window)
      ))
#+end_src

** evil-org
#+begin_src emacs-lisp
  ;; https://github.com/Somelauw/evil-org-mode/blob/master/doc/keythemes.org
  (use-package evil-org
    :ensure t
    :after org
    :config
    (add-hook 'org-mode-hook (lambda () org-superstar-mode))
    (require 'evil-org-agenda)
    (evil-org-agenda-set-keys))
#+end_src
** org-appear
#+begin_src emacs-lisp
(use-package org-appear
  :ensure t
  :after org
  :hook (org-mode . org-appear-mode)
  :config
  (defun org-apperance-evil-hack ()
    (add-hook 'evil-insert-state-entry-hook #'org-appear-manual-start nil t)
    (add-hook 'evil-insert-state-exit-hook #'org-appear-manual-stop nil t))
  (setq org-appear-trigger 'manual)
  (add-hook 'org-mode-hook #'org-apperance-evil-hack)
  )
#+end_src
** org-superstar
#+begin_src emacs-lisp
(use-package org-superstar
  :ensure t
  :after org
  :config
  (add-hook 'org-mode-hook (lambda () (org-superstar-mode 1)))
  (setq org-superstar-special-todo-items t)
  )
#+end_src
** org-protocol
#+begin_src emacs-lisp
#+end_src
** org-mac-link
#+begin_src emacs-lisp
(use-package org-mac-link)
#+end_src
** org-fragtog
#+begin_src emacs-lisp
(use-package org-fragtog
  :hook (org-mode . org-fragtog-mode))
#+end_src
** org-capture
#+begin_src emacs-lisp
(setq org-capture-templates
      '(("t" "Todo" entry (file+headline org-agenda-file-gtd "Workspace")
         "* TODO [#B] %?\n  %i\n %U"
         :empty-lines 1)
        ("n" "notes" entry (file+headline org-agenda-file-note "Quick notes")
         "* %?\n  %i\n %U"
         :empty-lines 1)
        ("b" "Blog Ideas" entry (file+headline org-agenda-file-note "Blog Ideas")
         "* TODO [#B] %?\n  %i\n %U"
         :empty-lines 1)
        ("s" "Slipbox" entry  (file "inbox.org")
         "* %?\n")
        ("S" "Code Snippet" entry
         (file org-agenda-file-code-snippet)
         "* %?\t%^g\n#+BEGIN_SRC %^{language}\n\n#+END_SRC")
        ("w" "work" entry (file+headline org-agenda-file-work "Work")
         "* TODO [#A] %?\n  %i\n %U"
         :empty-lines 1)
        ("x" "Web Collections" entry
         (file+headline org-agenda-file-note "Web")
         "* %U %:annotation\n\n%:initial\n\n%?")
        ("p" "Protocol" entry (file+headline org-agenda-file-note "Inbox")
         "* %^{Title}\nSource: %u, %c\n #+BEGIN_QUOTE\n%i\n#+END_QUOTE\n\n\n%?")
        ("L" "Protocol Link" entry (file+headline org-agenda-file-note "Inbox")
         "* %? [[%:link][%:description]] \nCaptured On: %U")
        ("c" "Chrome" entry (file+headline org-agenda-file-note "Quick notes")
         "* TODO [#C] %?\n %(zilongshanren/retrieve-chrome-current-tab-url)\n %i\n %U"
         :empty-lines 1)
        ("l" "links" entry (file+headline org-agenda-file-note "Quick notes")
         "* TODO [#C] %?\n  %i\n %a \n %U"
         :empty-lines 1)
        ("j" "Journal Entry"
         entry (file+datetree org-agenda-file-journal)
         "* %?"
         :empty-lines 1)))
#+end_src
** org-download
#+begin_src emacs-lisp
(use-package org-download
  :ensure t
  :hook (dired-mode . org-download-enable)
  :config
  (setq-default org-download-heading-lvl nil
                org-download-image-dir "~/.img/tmp/"
                ;; org-download-screenshot-method "screencapture -i %s"
                org-download-screenshot-method "pngpaste %s"
                org-download-screenshot-file (expand-file-name "screenshot.jpg" temporary-file-directory))
  )
#+end_src
** org-special-block-extras

More: [[http://alhassy.com/org-special-block-extras/][org-special-block-extras]]

red:text green:text [[color:#fad][Using Hex colour code!]]

kbd:C-c_C-c <kbd:C-c C-c>

#+begin_src emacs-lisp
(use-package org-special-block-extras
  :ensure t
  :after org
  :hook (org-mode . org-special-block-extras-mode)
  ;; All relevant Lisp functions are prefixed ‘o-’; e.g., `o-docs-insert'.
  :custom
  (o-docs-libraries
   '("~/.posts/documentations.org")
   "The places where I keep my ‘#+documentation’"))
#+end_src
** org-roam
#+begin_src emacs-lisp
(use-package org-roam
  :ensure t
  :after org
  :custom
  (org-roam-directory (file-truename user-blog-posts))
  (org-roam-dailies-directory "daily/")
  :config
  (defun gcl/org-capture-slipbox ()
    (interactive)
    (org-capture nil "s"))
  (cl-defmethod org-roam-node-type ((node org-roam-node))
    "Return the TYPE of NODE."
    (condition-case nil
        (file-name-nondirectory
         (directory-file-name
          (file-name-directory
           (file-relative-name (org-roam-node-file node) org-roam-directory))))
      (error "")))
  ;; If you're using a vertical completion framework, you might want a more informative completion interface
  (setq org-roam-node-display-template (concat "${title:*} " (propertize "${tags:10}" 'face 'org-tag)))
  (org-roam-db-autosync-mode)
  (setq org-roam-capture-templates
        '(("m" "main" plain
           "%?"
           :if-new (file+head "main/${slug}.org"
                              "#+title: ${title}\n")
           :immediate-finish t
           :unnarrowed t)
          ("r" "reference" plain "%?"
           :if-new
           (file+head "reference/${title}.org" "#+title: ${title}\n")
           :immediate-finish t
           :unnarrowed t)
          ("a" "article" plain "%?"
           :if-new
           (file+head "articles/${title}.org" "#+title: ${title}\n#+filetags: :article:\n")
           :immediate-finish t
           :unnarrowed t)))

  ;; If using org-roam-protocol
  (require 'org-roam-protocol)
  )
#+end_src
*** org-roam-ui
#+begin_src emacs-lisp
(use-package org-roam-ui
  :ensure t
  :after org-roam
  ;;         normally we'd recommend hooking orui after org-roam, but since org-roam does not have
  ;;         a hookable mode anymore, you're advised to pick something yourself
  ;;         if you don't care about startup time, use
  ;;  :hook (after-init . org-roam-ui-mode)
  :config
  (setq org-roam-ui-sync-theme t
        org-roam-ui-follow t
        org-roam-ui-update-on-save t
        org-roam-ui-open-on-start nil
	org-roam-ui-browser-function #'browse-url
	))
#+end_src
*** consult-org-roam
#+begin_src emacs-lisp
(use-package consult-org-roam
  :ensure t
  :after org-roam
  :init
  (require 'consult-org-roam)
  ;; Activate the minor mode
  (consult-org-roam-mode 1)
  :custom
  ;; Use `ripgrep' for searching with `consult-org-roam-search'
  (consult-org-roam-grep-func #'consult-ripgrep)
  ;; Configure a custom narrow key for `consult-buffer'
  (consult-org-roam-buffer-narrow-key ?r)
  ;; Display org-roam buffers right after non-org-roam buffers
  ;; in consult-buffer (and not down at the bottom)
  (consult-org-roam-buffer-after-buffers t)
  :config
  ;; Eventually suppress previewing for certain functions
  (consult-customize
   consult-org-roam-forward-links
   :preview-key (kbd "M-."))
  :bind
  ;; Define some convenient keybindings as an addition
  )
#+end_src
*** bindings
#+begin_src emacs-lisp
(general-define-key
 "C-c n f" 'org-roam-node-find
 "C-c n g" 'org-roam-graph
 "C-c n r" 'org-roam-node-random
 "C-c n c" 'org-roam-capture
 "C-c n d" 'org-roam-dailies-capture-today
 "C-c n u" 'org-roam-ui-open
 "C-c n e" 'consult-org-roam-file-find
 "C-c n b" 'consult-org-roam-backlinks
 "C-c n l" 'consult-org-roam-forward-links
 "C-c n s" 'consult-org-roam-search
 )

(general-def org-mode-map
  "C-c n i" 'org-roam-node-insert
  "C-c n o" 'org-id-get-create
  "C-c n t" 'org-roam-tag-add
  ;; "C-c n e" 'org-roam-extract-subtree
  "C-c n a" 'org-roam-alias-add
  "C-c n ," 'org-roam-buffer-toggle)
#+end_src
** org-bindings
#+begin_src emacs-lisp
(evil-define-key 'normal org-mode-map
  "tt" 'org-todo
  "tp" 'org-priority
  "td" 'org-deadline
  "tc" 'org-capture
  "tl" 'org-store-link
  "tn" 'org-add-note
  "t," 'org-toggle-checkbox

  ;; clock
  "ci" 'org-clock-in
  "co" 'org-clock-out
  "cg" 'org-clock-goto
  "cx" 'org-clock-cancel
  "ck" 'org-clock-timestamps-up
  "cj" 'org-clock-timestamps-down
  )
#+end_src
* Rime
#+begin_src emacs-lisp
(use-package rime
  :config
  (setq rime-user-data-dir "~/github/mine/dot-emacs-rime")
  (setq rime-share-data-dir "~/Library/Rime")
  (setq rime-posframe-properties
	(list
         :internal-border-color "#000000"
         :internal-border-width 10
         ;; :font "TsangerJinKai03-6763 W05"
         :font "WenQuanYi Micro Hei Mono-16"
         ))
					;； “”
					;； 默认的前景色和背景色（仅posframe）
					;； 编码提示颜色 - rime-comment-face
					;； 编码的颜色   - rime-code-face
					;； 候选序号颜色 - rime-candidate-num-face
  (set-face-attribute 'rime-default-face nil :foreground "#eeeeee" :background "#000000")

  (setq default-input-method "rime"
	rime-show-candidate 'posframe

	;; rime-default-face "Red" ;默认的前景色和背景色（仅posframe）
	;; rime-code-face ;编码的颜色
	;; rime-candidate-num-face ;候选序号颜色
	;; rime-comment-face ;编码提示颜色

	;; posframe/popup/sidewindow 候选版式
	;; simple - 单行, horizontal - 水平，默认, vertical - 垂直
	rime-posframe-style 'vertical
	;; rime-popup-style
	;; rime-sidewindow-style
	)
  					;； 代码中自动使用英文
  (setq rime-disable-predicates
	'(rime-predicate-evil-mode-p ; evil 模式
          ;; 在英文字符串之后（必须为以字母开头的英文字符串）
          rime-predicate-after-alphabet-char-p
          ;; 在 prog-mode 和 conf-mode 中除了注释和引号内字符串之外的区域
          rime-predicate-prog-in-code-p
          ;; 激活 ace-window-mode
          rime-predicate-ace-window-p
          ;; 如果激活了一个 hydra keymap
          rime-predicate-hydra-p
          ;; 将要输入的为大写字母时
          rime-predicate-current-uppercase-letter-p
          ;; 在 (La)TeX 数学环境中或者输入 (La)TeX 命令时
          rime-predicate-tex-math-or-command-p
          ))


;;;  support shift-l, shift-r, control-l, control-r
  (setq rime-inline-ascii-trigger 'shift-l)
  (setq rime-translate-keybindings
	'("C-`" "S-<delete>" "C-f" "C-b" "C-n" "C-p" "C-g" "<return>" "<left>" "<right>" "<up>" "<down>" "<prior>" "<next>" "<delete>"))
					;； 临时强制转成英文模式，通过 rime-inline-ascii 恢复中文模式（什么鬼～～～）
					;；　(define-key rime-active-mode-map (kbd "M-j") 'rime-inline-ascii)
  ;; (define-key rime-mode-map (kbd "M-j") 'rime-force-enable)
  (define-key rime-mode-map (kbd "C-`") 'rime-send-keybinding)

  (setq rime-emacs-module-header-root "/opt/homebrew/Cellar/emacs-plus@29/29.0.50/include")
  ;; (setq-default rime-librime-root (expand-file-name "librime/dist" user-emacs-directory))
  )
#+end_src
* flycheck
#+begin_src emacs-lisp
(use-package posframe)
#+end_src
* Window
** split-select-window
#+begin_src emacs-lisp
(defun split-window--select-window (orig-func &rest args)
  "Switch to the other window after a `split-window'"
  (let ((cur-window (selected-window))
        (new-window (apply orig-func args)))
    (when (equal (window-buffer cur-window) (window-buffer new-window))
      (select-window new-window))
    new-window))
(advice-add 'split-window :around #'split-window--select-window)
#+end_src

** duplicate-line
#+begin_src emacs-lisp
(use-package duplicate-line
  :straight (:host github :repo "manateelazycat/duplicate-line"))
#+end_src
** toggle-one-window
#+begin_src emacs-lisp
(use-package toggle-one-window
  :straight (:host github :repo "manateelazycat/toggle-one-window"))
#+end_src
** watch-other-window
#+begin_src emacs-lisp
(use-package watch-other-window
  :straight (:host github :repo "manateelazycat/watch-other-window"))
#+end_src
** window-numbering
#+begin_src emacs-lisp
(use-package window-numbering
  :config
  (add-hook 'after-init-hook 'window-numbering-mode))
#+end_src
* vterm
#+begin_src emacs-lisp
(use-package vterm)
(use-package multi-vterm :ensure t)
(use-package vterm-toggle)
(add-hook 'vterm-mode-hook
          (lambda ()
            (setq-local evil-insert-state-cursor 'box)
            (evil-insert-state)))
(define-key vterm-mode-map [return] #'vterm-send-return)
(define-key vterm-mode-map [(control return)]   #'vterm-toggle-insert-cd)
(define-key vterm-mode-map (kbd "s-n")   'vterm-toggle-forward)
(define-key vterm-mode-map (kbd "s-p")   'vterm-toggle-backward)
(setq vterm-toggle-fullscreen-p nil)
(add-to-list 'display-buffer-alist
             '((lambda (buffer-or-name _)
                 (let ((buffer (get-buffer buffer-or-name)))
                   (with-current-buffer buffer
                     (or (equal major-mode 'vterm-mode)
                         (string-prefix-p vterm-buffer-name (buffer-name buffer))))))
               (display-buffer-reuse-window display-buffer-at-bottom)
               ;;(display-buffer-reuse-window display-buffer-in-direction)
               ;;display-buffer-in-direction/direction/dedicated is added in emacs27
               ;;(direction . bottom)
               ;;(dedicated . t) ;dedicated is supported in emacs27
               (reusable-frames . visible)
               (window-height . 0.3)))
#+end_src
* 搜索
** engine-mode
#+begin_src emacs-lisp
(use-package engine-mode
  :ensure t
  :config
  (engine-mode t)

  (engine/set-keymap-prefix (kbd "C-c s"))
  (defengine baidu "https://www.baidu.com/s?wd=%s"
	     :keybinding "b")
  (defengine github
    "https://github.com/search?ref=simplesearch&q=%s"
    :keybinding "g")
  (defengine qwant
    "https://www.qwant.com/?q=%s"
    :docstring "什么都能搜到哦~~😍😍"
    :keybinding "q")
  (defengine rfcs
    "http://pretty-rfc.herokuapp.com/search?q=%s"
    :keybinding "r")
  (defengine stack-overflow
    "https://stackoverflow.com/search?q=%s"
    :keybinding "s")
  (defengine twitter
    "https://twitter.com/search?q=%s"
    :keybinding "t")
  (defengine wolfram-alpha
    "http://www.wolframalpha.com/input/?i=%s"
    :docstring "数学搜索引擎，公式，坐标图等。"
    :keybinding "w")
  (defengine google
    "http://www.google.com/search?ie=utf-8&oe=utf-8&q=%s"
    :keybinding "/")
  (defengine youtube
    "http://www.youtube.com/results?aq=f&oq=&search_query=%s"
    :keybinding "y")
  )
#+end_src
** consult

#+begin_src emacs-lisp
(use-package saveplace
  :hook (after-init . save-place-mode))

;; Example configuration for Consult
(use-package consult
  :hook (completion-list-mode . consult-preview-at-point-mode)
  :init
  (setq register-preview-delay 0.5
        register-preview-function #'consult-register-format)
  (advice-add #'register-preview :override #'consult-register-window)
  (setq xref-show-xrefs-function #'consult-xref
        xref-show-definitions-function #'consult-xref)
  :config
  (consult-customize
   consult-theme :preview-key '(:debounce 0.2 any)
   consult-ripgrep consult-git-grep consult-grep
   consult-bookmark consult-recent-file consult-xref
   consult--source-bookmark consult--source-file-register
   consult--source-recent-file consult--source-project-recent-file
   :preview-key '(:debounce 0.4 any))
  (setq consult-narrow-key "<") ;; (kbd "C-+")

  ;; (autoload 'projectile-project-root "projectile")
  ;; (setq consult-project-function (lambda (_) (projectile-project-root)))
  )
#+end_src
* 参考配置

[[https://github.com/purcell/emacs.d][purcell/emacs.d: An Emacs configuration bundle with batteries included]]
